using CounterStrikeSharp.API;
using CounterStrikeSharp.API.Core;
using CounterStrikeSharp.API.Core.Attributes.Registration;
using CounterStrikeSharp.API.Modules.Memory;
using CounterStrikeSharp.API.Modules.Utils;
using CounterStrikeSharp.API.Modules.Commands;
using System.Drawing;
using System.Reflection;

namespace Hauntess;

public class Hauntess : BasePlugin
{
    public override string ModuleName => "Hauntess_Darkness_System";
    public override string ModuleVersion => "2.3.0";

    private CFogController? _masterFogController;
    private bool _isHaunted = false;

    public override void Load(bool hotReload)
    {
        // Sync values constantly to prevent Workshop maps from resetting fog
        RegisterListener<Listeners.OnTick>(OnTick);
        
        RegisterListener<Listeners.OnMapStart>(mapName => {
            Console.WriteLine("[Hauntess] Map starting, resetting fog controller...");
            _masterFogController = null;
            
            if (_isHaunted)
            {
                AddTimer(2.0f, ApplyHauntedAtmosphere);
            }
        });

        RegisterEventHandler<EventPlayerSpawn>((@event, info) =>
        {
            if (!_isHaunted) return HookResult.Continue;
            
            var player = @event.Userid;
            if (player == null || !player.IsValid) return HookResult.Continue;
            
            int playerSlot = player.Slot;
            
            AddTimer(0.3f, () =>
            {
                var players = Utilities.GetPlayers();
                var currentPlayer = players.FirstOrDefault(p => p != null && p.IsValid && p.Slot == playerSlot);
                
                if (currentPlayer != null && currentPlayer.IsValid)
                {
                    currentPlayer.ExecuteClientCommand("cl_glow_brightness 0.0");
                    currentPlayer.ExecuteClientCommand("cl_drawhud_force_teamid_overhead -1");
                }
            });
            
            return HookResult.Continue;
        });

        if (hotReload && _isHaunted) 
        {
            ApplyHauntedAtmosphere();
        }
    }

    public void OnTick()
    {
        if (!_isHaunted) return;

        if (_masterFogController == null || !_masterFogController.IsValid)
        {
            _masterFogController = GetOrCreateMasterFog();
            if (_masterFogController == null) return;
        }

        foreach (CCSPlayerController player in Utilities.GetPlayers())
        {
            if (player == null || !player.IsValid || player.IsBot) continue;

            CCSPlayerPawn? pawn = player.PlayerPawn.Value;
            if (pawn == null || !pawn.IsValid) continue;

            try
            {
                // Force the player's camera to use Hauntess fog
                pawn.AcceptInput("SetFogController", _masterFogController, null, "!activator");

                // Sync memory values to override map defaults
                CFogController? currentFog = pawn.CameraServices?.PlayerFog?.Ctrl.Value;
                if (currentFog != null && _masterFogController != null)
                {
                    CopyValues(pawn.Skybox3d.Fog, _masterFogController.Fog);
                    SetStateChangeFogparams(pawn, "CBasePlayerPawn", "m_skybox3d", Schema.GetSchemaOffset("sky3dparams_t", "fog"));
                }
            }
            catch
            {
                // Silently skip any errors
            }
        }
    }

    private void ApplyHauntedAtmosphere()
    {
        try
        {
            Console.WriteLine("[Hauntess] === Applying Haunted Atmosphere ===");
            
            _masterFogController = GetOrCreateMasterFog();

            if (_masterFogController == null || !_masterFogController.IsValid)
            {
                Console.WriteLine("[Hauntess] ERROR: Failed to create fog controller!");
                Server.PrintToChatAll(" \x02[Hauntess] \x01ERROR: Could not create fog!");
                return;
            }

            // 1. NEUTRALIZE WORKSHOP OVERRIDES
            Console.WriteLine("[Hauntess] Disabling workshop lighting entities...");
            
            foreach (var gfog in Utilities.FindAllEntitiesByDesignerName<CBaseEntity>("env_gradient_fog"))
            {
                if (gfog != null && gfog.IsValid) gfog.AcceptInput("Disable");
            }

            foreach (var cfog in Utilities.FindAllEntitiesByDesignerName<CBaseEntity>("env_cubemap_fog"))
            {
                if (cfog != null && cfog.IsValid) cfog.AcceptInput("Disable");
            }

            foreach (var pp in Utilities.FindAllEntitiesByDesignerName<CBaseEntity>("post_processing_volume"))
            {
                if (pp != null && pp.IsValid) pp.AcceptInput("Disable");
            }

            // 2. DISABLE MAP LIGHTING & APPLY FOG
            Console.WriteLine("[Hauntess] Disabling map lighting...");
            Server.ExecuteCommand("ent_fire light_environment Disable");
            Server.ExecuteCommand("ent_fire env_sky_light Disable");
            
            Server.ExecuteCommand("ent_fire env_fog_controller SetStartDist 0");
            Server.ExecuteCommand("ent_fire env_fog_controller SetEndDist 350");
            Server.ExecuteCommand("ent_fire env_fog_controller SetFogMaxDensity 1.0");
            Server.ExecuteCommand("ent_fire env_fog_controller SetColorPrimary \"2 2 4\"");
            Server.ExecuteCommand("ent_fire env_fog_controller TurnOn");

            // 3. ENABLE DEADLY FRIENDLY FIRE
            Console.WriteLine("[Hauntess] Enabling Full Friendly Fire...");
            Server.ExecuteCommand("mp_friendlyfire 1");
            Server.ExecuteCommand("ff_damage_reduction_bullets 1.0");
            Server.ExecuteCommand("ff_damage_reduction_grenade 1.0");
            Server.ExecuteCommand("ff_damage_reduction_grenade_self 1.0");
            Server.ExecuteCommand("ff_damage_reduction_other 1.0");
            
            // Disable kicking for team damage
            Server.ExecuteCommand("mp_autokick 0");
            Server.ExecuteCommand("mp_td_dmgtokick 999999");
            Server.ExecuteCommand("mp_td_dmgtowarn 999999");
            Server.ExecuteCommand("mp_td_spawndmgthreshold 999999");

            // 4. APPLY TO ALL CURRENT PLAYERS
            Console.WriteLine("[Hauntess] Applying fog to current players...");
            int playerCount = 0;
            foreach (var player in Utilities.GetPlayers())
            {
                if (player == null || !player.IsValid) continue;

                player.ExecuteClientCommand("cl_glow_brightness 0.0");
                player.ExecuteClientCommand("cl_drawhud_force_teamid_overhead -1");

                var pawn = player.PlayerPawn.Value;
                if (pawn != null && pawn.IsValid)
                {
                    pawn.AcceptInput("SetFogController", _masterFogController, null, "!activator");
                    playerCount++;
                }
            }
            
            Console.WriteLine("[Hauntess] === Darkness & Chaos Applied Successfully ===");
            Server.PrintToChatAll(" \x07[Hauntess] \x01The void is here. \x02 FRIENDLY FIRE ENABLED (100% DAMAGE).");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Hauntess] ERROR in ApplyHauntedAtmosphere: {ex.Message}");
        }
    }

    private CFogController? GetOrCreateMasterFog()
    {
        try
        {
            string name = "Hauntess_Master_Fog";
            var existing = Utilities.FindAllEntitiesByDesignerName<CFogController>("env_fog_controller")
                .FirstOrDefault(e => e != null && e.IsValid && e.Entity?.Name == name);
            
            if (existing != null)
            {
                fogparams_t p = existing.Fog;
                p.Enable = true;
                p.ColorPrimary = Color.FromArgb(255, 2, 2, 4); 
                p.Start = 0.0f;
                p.End = 350.0f;
                p.Maxdensity = 1.0f;
                p.Exponent = 1.5f;
                
                SetStateChangeFogparams(existing, "CFogController", "m_fog");
                return existing;
            }

            CFogController? fog = Utilities.CreateEntityByName<CFogController>("env_fog_controller");
            if (fog == null) return null;

            fog.Entity!.Name = name;
            fog.DispatchSpawn();

            fogparams_t p2 = fog.Fog;
            p2.Enable = true;
            p2.ColorPrimary = Color.FromArgb(255, 2, 2, 4); 
            p2.Start = 0.0f;
            p2.End = 350.0f; 
            p2.Maxdensity = 1.0f;
            p2.Exponent = 1.5f;

            try
            {
                var visibility = Utilities.FindAllEntitiesByDesignerName<CPlayerVisibility>("env_player_visibility").FirstOrDefault();
                if (visibility != null && visibility.IsValid)
                {
                    visibility.FogMaxDensityMultiplier = 1.0f; 
                    Utilities.SetStateChanged(visibility, "CPlayerVisibility", "m_flFogMaxDensityMultiplier");
                }
            }
            catch {}

            SetStateChangeFogparams(fog, "CFogController", "m_fog");
            return fog;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Hauntess] ERROR in GetOrCreateMasterFog: {ex.Message}");
            return null;
        }
    }

    [ConsoleCommand("css_haunt", "Activate persistent darkness and friendly fire")]
    [ConsoleCommand("haunt", "Activate persistent darkness and friendly fire")]
    public void OnHauntCommand(CCSPlayerController? player, CommandInfo command)
    {
        Console.WriteLine("[Hauntess] HAUNT COMMAND RECEIVED");
        _isHaunted = true;
        ApplyHauntedAtmosphere();
    }

    [ConsoleCommand("css_unhaunt", "Restore normal lighting and safety")]
    [ConsoleCommand("unhaunt", "Restore normal lighting and safety")]
    public void OnUnhauntCommand(CCSPlayerController? player, CommandInfo command)
    {
        Console.WriteLine("[Hauntess] Unhaunt command received!");
        _isHaunted = false;

        Server.ExecuteCommand("ent_fire light_environment Enable");
        Server.ExecuteCommand("ent_fire env_sky_light Enable");
        Server.ExecuteCommand("ent_fire env_fog_controller TurnOff");
        
        // Disable Friendly Fire & Restore Kick Safety
        Server.ExecuteCommand("mp_friendlyfire 0");
        Server.ExecuteCommand("mp_autokick 1");
        Server.ExecuteCommand("mp_td_dmgtokick 300"); // Default CS2 value
        Server.ExecuteCommand("mp_td_dmgtowarn 200");
        
        // Reset damage multipliers to default (usually 0.33 or 1.0 depending on mode, resetting to safe default)
        Server.ExecuteCommand("ff_damage_reduction_bullets 0.33");
        Server.ExecuteCommand("ff_damage_reduction_grenade 0.85");

        foreach (var p in Utilities.GetPlayers())
        {
            if (p == null || !p.IsValid) continue;
            p.ExecuteClientCommand("cl_glow_brightness 1.0");
            p.ExecuteClientCommand("cl_drawhud_force_teamid_overhead 1");
        }

        if (_masterFogController != null && _masterFogController.IsValid)
        {
            _masterFogController.AcceptInput("TurnOff");
        }

        Server.PrintToChatAll(" \x06[Hauntess] \x01Light restored. Friendly Fire Disabled.");
    }

    [ConsoleCommand("css_haunt_test", "Test fog settings")]
    public void OnHauntTestCommand(CCSPlayerController? player, CommandInfo command)
    {
        if (_masterFogController == null || !_masterFogController.IsValid)
        {
            player?.PrintToChat("No fog controller exists!");
            return;
        }

        var fog = _masterFogController.Fog;
        player?.PrintToChat($"Fog: Enable={fog.Enable}, Start={fog.Start}, End={fog.End}, Density={fog.Maxdensity}");
        Console.WriteLine($"[Hauntess] Fog debug: Enable={fog.Enable}, Start={fog.Start}, End={fog.End}, Density={fog.Maxdensity}, Color={fog.ColorPrimary}");
    }

    // --- MEMORY HELPERS ---
    public static void SetStateChangeFogparams(CBaseEntity entity, string className, string fieldName, int extraOffset = 0)
    {
        try
        {
            string[] fields = { "start", "end", "maxdensity", "enable", "colorPrimary", "exponent" };
            foreach (string field in fields)
            {
                Utilities.SetStateChanged(entity, className, fieldName, extraOffset + Schema.GetSchemaOffset("fogparams_t", field));
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Hauntess] Error in SetStateChangeFogparams: {ex.Message}");
        }
    }

    public static void CopyValues<T>(T self, T other) where T : NativeObject
    {
        try
        {
            foreach (PropertyInfo property in self.GetType().GetProperties())
            {
                if (property.CanRead && property.CanWrite)
                {
                    property.SetValue(self, property.GetValue(other));
                }
            }
        }
        catch { }
    }
}